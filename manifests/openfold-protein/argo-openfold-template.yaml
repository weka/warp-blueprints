apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: openfold-pipeline
spec:
  # NEW: top-level entrypoint now runs a batch of proteins
  entrypoint: openfold-batch
  arguments:
    parameters:
      # JSON array of protein IDs to process
      # You can override this when submitting the workflow
      - name: protein-ids
        value: '["protein1.fasta", "protein2.fasta"]'
      - name: gpu-id
        value: "0"

  # Optional: global parallelism cap (max pods at once)
  # parallelism: 4

  # Shared volumes for all templates
  volumes:
    - name: openfold-data-pvc
      persistentVolumeClaim:
        claimName: openfold-data-pvc

  templates:
    # ------------------------------------------------------------------------
    # NEW: Batch wrapper â€“ fans out over multiple protein IDs
    # ------------------------------------------------------------------------
    - name: openfold-batch
      inputs:
        parameters:
          - name: protein-ids    # JSON array: ["p1", "p2", ...]
          - name: gpu-id
      steps:
        - - name: per-protein
            template: openfold-pipeline
            arguments:
              parameters:
                - name: protein-id
                  value: "{{item}}"                      # each protein ID
                - name: gpu-id
                  value: "{{inputs.parameters.gpu-id}}"
            # Fan-out over the protein list
            withParam: "{{inputs.parameters.protein-ids}}"

    # ------------------------------------------------------------------------
    # Single-protein pipeline: CPU step then GPU step
    # ------------------------------------------------------------------------
    - name: openfold-pipeline
      inputs:
        parameters:
          - name: protein-id
          - name: gpu-id
      steps:
        - - name: cpu-preprocess
            template: gpu-mmseq2-preprocess
            arguments:
              parameters:
                - name: protein-id
                  value: "{{inputs.parameters.protein-id}}"

        - - name: gpu-inference
            template: gpu-inference
            arguments:
              parameters:
                - name: protein-id
                  value: "{{inputs.parameters.protein-id}}"
                - name: gpu-id
                  value: "{{inputs.parameters.gpu-id}}"

    # ------------------------------------------------------------------------
    # CPU-only alignment step (per protein)
    # ------------------------------------------------------------------------
    - name: gpu-mmseq2-preprocess
      inputs:
        parameters:
          - name: protein-id
      container:
        image: wekachrisjen/warp-openfold-cpu:v0.11
        command: ["python", "run_mmseq_pipeline.py"]
        args:
          - "--protein-id"
          - "{{inputs.parameters.protein-id}}"
        resources:
          requests:
            cpu: "8"
            memory: "16Gi"
          limits:
            cpu: "16"
            memory: "32Gi"
        volumeMounts:
          - name: openfold-data-pvc
            mountPath: /data

    # ------------------------------------------------------------------------
    # GPU-only inference step (per protein)
    # ------------------------------------------------------------------------
    - name: gpu-inference
      inputs:
        parameters:
          - name: protein-id
          - name: gpu-id
      container:
        image: wekachrisjen/warp-openfold-gpu:v0.1
        command: ["python", "run_gpu_inference.py"]
        args:
          - "--protein-id"
          - "{{inputs.parameters.protein-id}}"
          - "--gpu-id"
          - "{{inputs.parameters.gpu-id}}"
        resources:
          requests:
            cpu: "2"
            memory: "16Gi"
            nvidia.com/gpu: 1
          limits:
            cpu: "4"
            memory: "32Gi"
            nvidia.com/gpu: 1
        volumeMounts:
          - name: openfold-data-pvc
            mountPath: /data
        nodeSelector:
          nvidia.com/gpu.present: "true"