apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: openfold-db-bootstrap
spec:
  entrypoint: bootstrap-databases

  # User-editable parameters (appear in Argo UI)
  arguments:
    parameters:
      - name: pdb70-root
        value: "/data/databases/pdb70"
      - name: pdb70-url
        value: "https://wwwuser.gwdg.de/~compbiol/data/hhsuite/databases/hhsuite_dbs/pdb70_from_mmcif_latest.tar.gz"
      # Which UniRef preset to use with `mmseqs databases`
      - name: uniref-source
        value: "UniRef50"
      # Local directory name under /data/databases
      - name: uniref-name
        value: "uniref50"

  # Optional: cap overall concurrent pods for this workflow
  parallelism: 4

  volumes:
    - name: openfold-data
      persistentVolumeClaim:
        claimName: openfold-data-pvc

  templates:
    # ============================
    # Top-level: run PDB70 + UniRef in parallel
    # ============================
    - name: bootstrap-databases
      steps:
        - - name: download-pdb70
            template: download-pdb70
          - name: build-uniref
            template: build-uniref

    # ============================
    # PDB70 downloader (1 pod)
    # ============================
    - name: download-pdb70
      container:
        image: wekachrisjen/warp-openfold-cpu:v0.5
        imagePullPolicy: IfNotPresent
        command: ["bash", "-c"]
        args:
          - |
            set -euo pipefail

            log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INIT-PDB70] $*" >&2
            }

            PDB70_ROOT="{{workflow.parameters.pdb70-root}}"
            PDB70_URL="{{workflow.parameters.pdb70-url}}"
            PDB70_TARBALL="pdb70_from_mmcif_latest.tar.gz"

            log "Ensuring PDB70 root directory exists at ${PDB70_ROOT}"
            mkdir -p "${PDB70_ROOT}"
            cd "${PDB70_ROOT}"

            # Already present?
            if ls pdb70_cs219.ffdata >/dev/null 2>&1; then
              log "PDB70 already installed. Nothing to do."
              exit 0
            fi

            log "PDB70 not found. Downloading from ${PDB70_URL}"

            if command -v curl >/dev/null 2>&1; then
              curl -L -o "${PDB70_TARBALL}" "${PDB70_URL}"
            else
              wget -O "${PDB70_TARBALL}" "${PDB70_URL}"
            fi

            log "Extracting PDB70 tarball..."
            tar -xzf "${PDB70_TARBALL}"

            log "Locating pdb70_cs219.ffdata..."
            inner_file="$(find "${PDB70_ROOT}" -maxdepth 3 -type f -name 'pdb70_cs219.ffdata' | head -n 1 || true)"

            if [ -z "${inner_file}" ]; then
              log "ERROR: Could not locate pdb70_cs219.ffdata after extracting tarball."
              exit 1
            fi

            inner_dir="$(dirname "${inner_file}")"
            log "Found pdb70 files inside ${inner_dir}"

            # Symlink all pdb70_* files into the root directory
            for f in "${inner_dir}"/pdb70_*; do
              base="$(basename "${f}")"
              if [ ! -e "${PDB70_ROOT}/${base}" ]; then
                ln -s "${f}" "${PDB70_ROOT}/${base}"
                log "Linked ${base}"
              fi
            done

            if [ ! -f "${PDB70_ROOT}/pdb70_cs219.ffdata" ]; then
              log "ERROR: PDB70 installation incomplete."
              exit 1
            fi

            log "PDB70 installed successfully at ${PDB70_ROOT}"
        volumeMounts:
          - name: openfold-data
            mountPath: /data

    # ============================
    # UniRef MMseqs DB builder (1 pod)
    # Uses user-selected UniRef DB and local name
    # ============================
    - name: build-uniref
      container:
        image: wekachrisjen/warp-openfold-cpu:v0.5
        imagePullPolicy: IfNotPresent
        env:
          - name: MMSEQS_THREADS
            value: "32"
        command: ["bash", "-c"]
        args:
          - |
            set -euo pipefail

            log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INIT-UNIREF] $*" >&2
            }

            UNIREFF_SOURCE="{{workflow.parameters.uniref-source}}"
            UNIREFF_NAME="{{workflow.parameters.uniref-name}}"

            DB_DIR="/data/databases/${UNIREFF_NAME}"
            DB_PREFIX="${DB_DIR}/${UNIREFF_NAME}_mmseqs"

            log "Using UniRef source preset: ${UNIREFF_SOURCE}"
            log "Target directory: ${DB_DIR}"
            log "Target MMseqs DB prefix: ${DB_PREFIX}"

            mkdir -p "${DB_DIR}" /data/tmp

            # If DB already exists, skip rebuild
            if ls "${DB_PREFIX}".dbtype >/dev/null 2>&1; then
              log "MMseqs DB '${DB_PREFIX}' already exists. Skipping build."
              exit 0
            fi

            log "Building ${UNIREFF_SOURCE} MMseqs database..."
            mmseqs databases "${UNIREFF_SOURCE}" \
              "${DB_PREFIX}" \
              /data/tmp \
              --threads "${MMSEQS_THREADS:-32}"

            log "${UNIREFF_SOURCE} MMseqs database build complete at ${DB_PREFIX}"
        volumeMounts:
          - name: openfold-data
            mountPath: /data