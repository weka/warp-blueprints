---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ngc-secret-creator
  namespace: vss
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ngc-secret-creator-role
  namespace: vss
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "delete", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ngc-secret-creator-binding
  namespace: vss
subjects:
  - kind: ServiceAccount
    name: ngc-secret-creator
    namespace: default
roleRef:
  kind: Role
  name: ngc-secret-creator-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: create-ngc-docker-secret
  namespace: vss
spec:
  backoffLimit: 1
  template:
    spec:
      serviceAccountName: ngc-secret-creator
      restartPolicy: Never
      containers:
        - name: create-ngc-docker-secret
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              set -euo pipefail

              NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
              SECRET_NAME_SOURCE="ngc-api-key"
              SECRET_NAME_TARGET="ngc-docker-reg-secret"

              echo "Using namespace: ${NAMESPACE}"
              echo "Reading NGC_API_KEY from secret: ${SECRET_NAME_SOURCE}"

              # 1) Extract NGC_API_KEY from the generic secret
              NGC_API_KEY=$(kubectl get secret "${SECRET_NAME_SOURCE}" \
                -n "${NAMESPACE}" \
                -o jsonpath='{.data.NGC_API_KEY}' | base64 -d)

              if [ -z "${NGC_API_KEY}" ]; then
                echo "ERROR: NGC_API_KEY is empty or secret ${SECRET_NAME_SOURCE} not found" >&2
                exit 1
              fi

              echo "Deleting existing ${SECRET_NAME_TARGET} (if any)..."
              kubectl delete secret "${SECRET_NAME_TARGET}" -n "${NAMESPACE}" --ignore-not-found=true

              echo "Creating docker-registry secret ${SECRET_NAME_TARGET}..."
              kubectl create secret docker-registry "${SECRET_NAME_TARGET}" \
                -n "${NAMESPACE}" \
                --docker-server=nvcr.io \
                --docker-username='$oauthtoken' \
                --docker-password="${NGC_API_KEY}"

              echo "Docker registry secret ${SECRET_NAME_TARGET} created successfully."